<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Sender</title>
    <style>
      html,
      body {
        font-family: 'Roboto', sans-serif;
      }
      .container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
      }
      h1 {
        text-align: center;
        width: 100%;
      }
      button {
        padding: 1.5rem 3rem;
        border-radius: 9999px;
        border: none;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 1.25rem;
      }
      button.record {
        background-color: #3b82f6;
      }

      button.record:hover {
        background-color: #2563eb;
      }

      button.stop {
        background-color: #ef4444;
      }

      button.stop:hover {
        background-color: #dc2626;
      }

      button.permission {
        background-color: #eab308;
        font-size: 0.875rem;
      }

      button.permission:hover {
        background-color: #ca8a04;
      }

      .error {
        color: #dc2626;
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }

      .status {
        font-size: 0.875rem;
        color: #4b5563;
      }

      .permission-status {
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }

      .permission-status.granted {
        color: #16a34a;
      }

      .permission-status.denied {
        color: #ca8a04;
      }
      .link-sender {
        font-size: 0.75rem;
        color: #6b7280;
        text-decoration: underline;
        background: none;
        padding: 0.25rem;
        margin-top: auto;
      }
      .link-sender:hover {
        color: #374151;
        background: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>TOUR MIC</h1>
      <button id="recordButton" class="record">ON-AIR</button>
      <div id="error" class="error" style="display: none"></div>
      <div id="permissionStatus" class="permission-status" style="display: none"></div>
      <button id="permissionButton" class="permission" style="display: none">마이크 권한</button>
      <a href="/index.html" class="link-sender">리시버 페이지로</a>
      <div id="recordingStatus" class="status" style="display: none">Recording and streaming audio...</div>
    </div>
    <script>
      // Register service worker for offline support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/service-worker.js');
            console.log('ServiceWorker registration successful with scope:', registration.scope);
          } catch (error) {
            console.error('ServiceWorker registration failed:', error);
          }
        });
      }

      let isRecording = false;
      let wsConnection = null;
      let mediaRecorderRef = null;
      let permissionStatus = 'prompt';

      // Check for insecure origin
      if (window.location.protocol === 'http:') {
        console.log('Running on HTTP - attempting to enable insecure origins flag');
        console.log('Please enable "Insecure origins treated as secure" in chrome://flags');
      }

      // Initialize WebSocket connection
      function initWebSocket() {
        const wsUrl = '192.168.0.66';
        const ws = new WebSocket(`ws://${wsUrl}:8080`);
        console.log(`Sending to WebSocket server`, ws);
        ws.binaryType = 'arraybuffer';
        wsConnection = ws;

        ws.onclose = () => {
          console.log('WebSocket connection closed');
          setTimeout(initWebSocket, 1000); // Attempt to reconnect
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          showError('WebSocket connection error');
        };
      }

      // Initialize WebSocket
      initWebSocket();

      // Check microphone permissions
      if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions
          .query({ name: 'microphone' })
          .then((status) => {
            console.log('Microphone permission status:', status.state);
            updatePermissionStatus(status.state);
            status.onchange = () => {
              console.log('Permission status changed:', status.state);
              updatePermissionStatus(status.state);
            };
          })
          .catch((err) => {
            console.error('Error checking permission:', err);
          });
      }

      function updatePermissionStatus(status) {
        permissionStatus = status;
        const statusElement = document.getElementById('permissionStatus');
        const permissionButton = document.getElementById('permissionButton');

        statusElement.style.display = status !== 'prompt' ? 'block' : 'none';
        statusElement.textContent = `마이크 사용권한: ${status}`;
        statusElement.className = `permission-status ${status === 'granted' ? 'granted' : 'deny'}`;

        permissionButton.style.display = status === 'denied' ? 'block' : 'none';
      }

      async function requestPermission() {
        try {
          const result = await navigator.permissions.query({ name: 'microphone' });
          if (result.state === 'denied') {
            showError('마이크권한 획득 실패');
          }
        } catch (error) {
          console.error('권한요청 쿼리 실패:', error);
        }
      }

      function showError(message) {
        const errorElement = document.getElementById('error');
        errorElement.textContent = `Error: ${message}`;
        errorElement.style.display = 'block';
      }

      async function startRecording() {
        try {
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('MediaDevices API not supported. "Insecure origins treated as secure" in chrome://flags');
          }

          const constraints = {
            audio: {
              channelCount: 1,
              sampleRate: 22050,
              sampleSize: 16,
            },
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);

          // Create Audio Context to handle raw PCM
          const audioContext = new AudioContext({ sampleRate: 22050 });
          const source = audioContext.createMediaStreamSource(stream);
          const processor = audioContext.createScriptProcessor(2048, 1, 1);

          source.connect(processor);
          processor.connect(audioContext.destination);

          processor.onaudioprocess = (e) => {
            if (wsConnection?.readyState === WebSocket.OPEN) {
              const inputData = e.inputBuffer.getChannelData(0);
              wsConnection.send(inputData.buffer);
            }
          };

          mediaRecorderRef = {
            stop: () => {
              processor.disconnect();
              source.disconnect();
              audioContext.close();
              stream.getTracks().forEach((track) => track.stop());
            },
          };

          isRecording = true;
          updateUI();
          document.getElementById('error').style.display = 'none';
        } catch (error) {
          const errorMessage = error instanceof Error ? `${error.name}: ${error.message}` : '마이크 권한 거절. Check "Insecure origins treated as secure" in chrome://flags';
          console.error('Error accessing microphone:', errorMessage);
          showError(errorMessage);
        }
      }

      function stopRecording() {
        if (mediaRecorderRef) {
          mediaRecorderRef.stop();
          isRecording = false;
          updateUI();
        }
      }

      function updateUI() {
        const recordButton = document.getElementById('recordButton');
        const recordingStatus = document.getElementById('recordingStatus');

        if (isRecording) {
          recordButton.textContent = 'STOP';
          recordButton.className = 'stop';
          recordingStatus.style.display = 'block';
        } else {
          recordButton.textContent = 'ON-AIR';
          recordButton.className = 'record';
          recordingStatus.style.display = 'none';
        }
      }

      // Event Listeners
      document.getElementById('recordButton').addEventListener('click', () => {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      });

      document.getElementById('permissionButton').addEventListener('click', requestPermission);
    </script>
  </body>
</html>
